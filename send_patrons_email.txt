import asyncio
import smtplib
import logging
from email.mime.text import MIMEText
from email.mime.multipart import MIMEMultipart
import os
from dotenv import load_dotenv

# Set up logging
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(levelname)s - %(message)s',
    datefmt='%Y-%m-%d %H:%M:%S'
)
logger = logging.getLogger(__name__)

# Load environment variables
load_dotenv()

async def get_paid_patron_emails() -> list:
    """Get emails of all active paid patrons"""
    try:
        logger.info("Initializing Patreon client...")
        client = PatreonClient()
        client.initialize()
        
        logger.info("Fetching campaign members...")
        members = await client.get_campaign_members()
        
        paid_patrons = []
        for member in members:
            attributes = member.get("attributes", {})
            if (attributes.get("patron_status") == "active_patron" and 
                attributes.get("currently_entitled_amount_cents", 0) > 0):
                email = attributes.get("email")
                if email:
                    paid_patrons.append({
                        "email": email,
                        "name": attributes.get("full_name", "Valued Patron")
                    })
                    logger.info(f"Found paid patron: {email}")
        
        logger.info(f"Total paid patrons found: {len(paid_patrons)}")
        return paid_patrons
        
    except Exception as e:
        logger.error(f"Error getting paid patron info: {str(e)}", exc_info=True)
        return []

def send_bulk_email(recipients: list, subject: str, body: str):
    """Send email to all patrons"""
    sender_email = os.getenv("GMAIL_EMAIL")
    sender_password = os.getenv("GMAIL_APP_PASSWORD")
    
    try:
        logger.info("Establishing SMTP connection...")
        server = smtplib.SMTP("smtp.gmail.com", 587)
        server.starttls()
        server.login(sender_email, sender_password)
        
        for recipient in recipients:
            try:
                msg = MIMEMultipart()
                msg["From"] = sender_email
                msg["To"] = recipient["email"]
                msg["Subject"] = subject
                
                # Personalize the body with recipient's name
                personalized_body = f"Dear {recipient['name']},\n\n{body}"
                msg.attach(MIMEText(personalized_body, "plain"))
                
                logger.info(f"Sending email to {recipient['email']}")
                server.send_message(msg)
                logger.info(f"Successfully sent email to {recipient['email']}")
                
                # Small delay to avoid overwhelming the server
                asyncio.sleep(1)
                
            except Exception as e:
                logger.error(f"Error sending to {recipient['email']}: {str(e)}")
                continue
        
        server.quit()
        logger.info("All emails sent. SMTP connection closed")
        
    except Exception as e:
        logger.error(f"SMTP error: {str(e)}", exc_info=True)

async def main():
    logger.info("Starting email distribution process...")
    
    # Get all paid patrons
    patrons = await get_paid_patron_emails()
    
    if not patrons:
        logger.error("No paid patrons found!")
        return
    
    print(f"\nFound {len(patrons)} paid patrons")
    
    # Get email content
    print("\nEnter email subject:")
    subject = input()
    
    print("\nEnter email body (press Enter twice to finish):")
    lines = []
    while True:
        line = input()
        if line == "":
            break
        lines.append(line)
    body = "\n".join(lines)
    
    # Preview
    print("\nEmail Preview:")
    print(f"Subject: {subject}")
    print(f"Body:\n{body}")
    
    # Confirm
    confirm = input("\nSend this email to all paid patrons? (yes/no): ")
    if confirm.lower() == 'yes':
        send_bulk_email(patrons, subject, body)
        logger.info("Email distribution completed!")
    else:
        logger.info("Email distribution cancelled")

if __name__ == "__main__":
    try:
        asyncio.run(main())
    except KeyboardInterrupt:
        logger.info("\nProcess interrupted by user")
    except Exception as e:
        logger.error("Process failed!", exc_info=True)