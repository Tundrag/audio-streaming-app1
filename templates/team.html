{% extends "base.html" %}

{% block title %}Team Management - Music Streaming App{% endblock %}

{% block page_title %}Team Management{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', path='/css/team.css') }}">
{% endblock %}

{% block content %}
    <!-- âœ… Bootstrap data for SSR hydration -->
    <script id="team-bootstrap-data" type="application/json">
        {
            "members": {{ team_members | tojson | safe }}
        }
    </script>

    <main class="team-management">
        <section class="team-header">
            <h2>Team Management</h2>
            <button class="add-team-btn" onclick="teamManagement.openAddTeamModal()">
                <i class="fas fa-plus"></i> Add Team Member
            </button>
        </section>

        <section id="teamMembersGrid" class="team-grid">
            <!-- Team members will be rendered here -->
            <div class="empty-collection">
                <i class="fas fa-spinner fa-spin"></i>
                <h2>Loading Team Members</h2>
                <p>Please wait while we load your team members...</p>
            </div>
        </section>
    </main>

    <!-- Add Team Member Modal -->
    <div id="addTeamModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add Team Member</h2>
                <button class="modal-close" onclick="closeAddTeamModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form id="addTeamForm" onsubmit="return false;">
                <div class="form-group">
                    <label for="teamEmail">Email</label>
                    <div class="input-wrapper">
                        <i class="fas fa-envelope"></i>
                        <input type="email" id="teamEmail" placeholder="Enter email address" required>
                    </div>
                </div>

                <div class="form-group">
                    <label for="teamUsername">Username</label>
                    <div class="input-wrapper">
                        <i class="fas fa-user"></i>
                        <input type="text" id="teamUsername" placeholder="Enter username" required>
                    </div>
                </div>

                <div class="form-group">
                    <label for="teamPassword">Password</label>
                    <div class="input-wrapper">
                        <i class="fas fa-lock"></i>
                        <input type="password" id="teamPassword" placeholder="Enter password" required>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn-cancel" onclick="closeAddTeamModal()">
                        Cancel
                    </button>
                    <button type="button" class="btn-primary" onclick="addTeamMember()">
                        <i class="fas fa-plus"></i>
                        Add Member
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Team Member Details Modal -->
    <div id="editDetailsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit Team Member Details</h2>
                <button class="modal-close" onclick="closeEditDetailsModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form id="editDetailsForm">
                <div class="form-group">
                    <label for="editEmail">Email</label>
                    <div class="input-wrapper">
                        <i class="fas fa-envelope"></i>
                        <input type="email" id="editEmail" placeholder="Enter new email">
                    </div>
                </div>

                <div class="form-group">
                    <label for="editUsername">Username</label>
                    <div class="input-wrapper">
                        <i class="fas fa-user"></i>
                        <input type="text" id="editUsername" placeholder="Enter new username">
                    </div>
                </div>

                <div class="form-group">
                    <label for="editPassword">New Password</label>
                    <div class="input-wrapper">
                        <i class="fas fa-lock"></i>
                        <input type="password" id="editPassword" placeholder="Enter new password (optional)">
                    </div>
                    <small>Leave blank to keep current password</small>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn-cancel" onclick="closeEditDetailsModal()">
                        Cancel
                    </button>
                    <button type="button" class="btn-primary" onclick="saveTeamDetails()">
                        <i class="fas fa-save"></i>
                        Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Team Permissions Modal -->
    <div id="editPermissionsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit Team Permissions</h2>
                <button class="modal-close" onclick="closeEditPermissionsModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form id="editPermissionsForm">
                <div class="permissions-grid">
                    <div class="permission-section">
                        <h4><i class="fas fa-download"></i> Download Permissions</h4>
                        <div class="form-group">
                            <label>Album Downloads (per month)</label>
                            <input type="number" id="albumDownloadsAllowed" min="0" max="100" value="0">
                            <small>Number of albums this member can download per month</small>
                        </div>
                        
                        <div class="form-group">
                            <label>Track Downloads (per month)</label>
                            <input type="number" id="trackDownloadsAllowed" min="0" max="500" value="0">
                            <small>Number of tracks this member can download per month</small>
                        </div>
                    </div>

                    <div class="permission-section">
                        <h4><i class="fas fa-book"></i> Book Request Permissions</h4>
                        <div class="form-group">
                            <label>Book Requests (per month)</label>
                            <input type="number" id="bookRequestsAllowed" min="0" max="20" value="0">
                            <small>Number of book requests this member can make per month</small>
                        </div>
                    </div>

                    <div class="permission-section">
                        <h4><i class="fas fa-trash-alt"></i> Deletion Permissions</h4>
                        <div class="form-group">
                            <label>Album Deletions (per 24 hours)</label>
                            <input type="number" id="albumDeletionsAllowed" min="0" max="10" value="0">
                            <small>Number of albums this member can delete every 24 hours</small>
                        </div>
                        
                        <div class="form-group">
                            <label>Track Deletions (per 24 hours)</label>
                            <input type="number" id="trackDeletionsAllowed" min="0" max="50" value="0">
                            <small>Number of tracks this member can delete every 24 hours</small>
                        </div>
                    </div>
                </div>
                
                <div id="currentUsage" class="usage-info"></div>
                
                <div class="modal-footer">
                    <button type="button" class="btn-cancel" onclick="closeEditPermissionsModal()">Cancel</button>
                    <button type="button" class="btn-primary" onclick="saveTeamPermissions()">
                        <i class="fas fa-save"></i> Save Permissions
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
    import { TeamManagementController } from '/static/js/team-shared-spa.js?v={{ APP_VERSION }}';
    
    // Initialize in SSR mode
    let teamManagement;
    
    document.addEventListener('DOMContentLoaded', async () => {
        teamManagement = new TeamManagementController('ssr');
        window.teamManagement = teamManagement;
        
        await teamManagement.mount();
    });
    
    // Clean up on page unload
    window.addEventListener('beforeunload', () => {
        if (teamManagement) {
            teamManagement.destroy();
        }
    });
    </script>
{% endblock %}